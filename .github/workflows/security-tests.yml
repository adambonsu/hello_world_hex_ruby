name: SecurityTests
on:
    workflow_call:
    workflow_dispatch:

jobs:
    security-tests:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0
            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: 3.0
                  bundler-cache: true
            - name: SAST(Talisman) - Detect secrets in commits
              uses: carhartl/talisman-secrets-scan-action@v1.4.0
            - name: Dependency Check
              uses: dependency-check/Dependency-Check_Action@main
              with:
                  project: 'hello_world_hex_ruby'
                  path: '.'
                  format: 'HTML'
                  out: 'dependency-check'
            - name: Upload Dependency Check Report
              uses: actions/upload-artifact@v4
              with:
                  name: dependency-check
                  path: ${{github.workspace}}/dependency-check
            - name: Set up Snyk
              uses: snyk/actions/setup@master
              env:
                SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
            - name: Check Snyk Token is set
              run: "[[ -z \"${SNYK_TOKEN}\" ]] && echo \"SNYK_TOKEN is not set\" || echo \"SNYK_TOKEN is set\""
              env:
                SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
            - name: Check Snyk Version
              run: snyk --version
            - name: Run Snyk test with logging
              run: export SNYK_TOKEN=$SNYK_TOKEN && snyk test --all-projects --sarif-file-output=snyk.sarif --debug
              env:
                SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
            - name: Run Snyk test
              run: snyk test --all-projects --sarif-file-output=snyk.sarif
              env:
                SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
            - name: Upload Snyk Report
              uses: github/codeql-action/upload-sarif@v2
              with:
                  sarif_file: snyk.sarif
